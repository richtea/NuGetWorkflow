name: CI Build

on:
  pull_request:
    branches: 
    - main
  workflow_dispatch:

jobs:
  build:
    env:
      BUILD_CONFIG: 'Release'
      SOLUTION: 'NuGetWorkflow.sln'

    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Setup mono-complete
      run: |
        if command -v mono &> /dev/null; then
          echo "Mono is already installed"
        else
          sudo apt install gnupg ca-certificates
          sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 3FA7E0328081BFF6A14DA29AA6A19B38D3D831EF
          echo "deb https://download.mono-project.com/repo/ubuntu stable-focal main" | \
            sudo tee /etc/apt/sources.list.d/mono-official-stable.list
          sudo apt update
          sudo apt install -y mono-complete
        fi

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 6.0.x

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v1.0.5

    - name: Restore dependencies
      run: dotnet restore $SOLUTION

    - name: Build
      run: >-
        dotnet build $SOLUTION
        --configuration $BUILD_CONFIG
        --no-restore

    - name: Run tests
      run: >-
        dotnet test
        --configuration $BUILD_CONFIG
        --no-restore
        --no-build
        --verbosity normal
        --logger "GitHubActions;annotations.titleFormat=\$test;annotations.messageFormat=\$error"
